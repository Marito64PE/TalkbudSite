<!doctype html>

<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>TalkBud ‚Äî Demo escolar (TTS & Audio Manager)</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--bg:#0f1724;--card:#0b1220;--muted:#9aa4b2;--accent:#7dd3fc;--accent-2:#60a5fa}
    *{box-sizing:border-box;font-family:'Inter',system-ui,Segoe UI,Roboto,Arial,sans-serif}
    body{margin:0;background:linear-gradient(180deg,#071023 0%, #071627 100%);color:#e6eef8;min-height:100vh;display:flex;align-items:center;justify-content:center;padding:28px}
    .container{width:100%;max-width:1100px}
    header{display:flex;align-items:center;gap:16px;margin-bottom:18px}
    .logo{width:56px;height:56px;border-radius:12px;background:linear-gradient(135deg,var(--accent),var(--accent-2));display:flex;align-items:center;justify-content:center;font-weight:800;color:#022;box-shadow:0 6px 20px rgba(0,0,0,.45)}
    h1{font-size:20px;margin:0}
    p.lead{margin:0;color:var(--muted);font-size:13px}

```
.grid{display:grid;grid-template-columns:1fr 360px;gap:18px}
.card{background:rgba(255,255,255,0.03);padding:18px;border-radius:12px;box-shadow:0 4px 30px rgba(2,6,23,.6);border:1px solid rgba(255,255,255,0.03)}

label{font-size:13px;color:var(--muted);display:block;margin-bottom:6px}
textarea{width:100%;min-height:140px;background:transparent;border:1px solid rgba(255,255,255,0.04);padding:12px;border-radius:8px;color:inherit;outline:none;resize:vertical}
select,input[type=text],input[type=file]{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}

.row{display:flex;gap:10px;align-items:center}
.btn{background:linear-gradient(90deg,var(--accent),var(--accent-2));border:none;color:#022;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700}
.btn.ghost{background:transparent;border:1px solid rgba(255,255,255,.06);color:var(--accent)}
.small{font-size:12px;color:var(--muted)}
.list{max-height:320px;overflow:auto;margin-top:10px;padding-right:6px}
.item{display:flex;align-items:center;justify-content:space-between;padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg, rgba(255,255,255,0.012), rgba(255,255,255,0.008));border:1px solid rgba(255,255,255,0.02)}
.meta{display:flex;gap:10px;align-items:center}
.filename{font-weight:600}
.actions{display:flex;gap:8px}
audio{width:100%;margin-top:12px;background:#000;border-radius:8px;padding:6px}
.note{font-size:13px;color:var(--muted);margin-top:8px}
ol.note{padding-left:18px;color:var(--muted)}
footer{margin-top:14px;color:var(--muted);font-size:13px;text-align:center}

@media (max-width:880px){.grid{grid-template-columns:1fr}.container{padding:0 12px}}
```

  </style>
</head>
<body>
  <div class="container">
    <header>
      <div class="logo">TB</div>
      <div>
        <h1>TalkBud ‚Äî Audio Manager (Demo escolar)</h1>
        <p class="lead">Genera, reproduce y prepara audios para tu dispositivo ‚Äî dise√±o minimalista y seguro.</p>
      </div>
    </header>

```
<div class="grid">
  <!-- MAIN -->
  <main class="card">
    <label for="text">Frase</label>
    <textarea id="text">Hola, soy TalkBud. Presiona el bot√≥n para reproducir.</textarea>

    <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:160px;">
        <label for="voice">Voz (ElevenLabs)</label>
        <select id="voice">
          <option value="ErXwobaYiN019PkySvjV">Antoni (ES)</option>
          <option value="pNInz6obpgDQGcFmaJgB">Paula (ES)</option>
          <option value="21m00Tcm4TlvDq8ikWAM">Rachel (EN)</option>
        </select>
      </div>

      <div style="width:120px;">
        <label for="format">Formato</label>
        <select id="format"><option value="mp3">MP3</option><option value="wav">WAV</option></select>
      </div>

      <div style="width:120px;">
        <label for="lang">Idioma (preview)</label>
        <select id="lang"><option value="es-ES">Espa√±ol (ES)</option><option value="es-MX">Espa√±ol (MX)</option><option value="en-US">English (US)</option></select>
      </div>
    </div>

    <div class="row controls" style="margin-top:12px;">
      <button class="btn" id="genBtn">Generar & Descargar</button>
      <button class="btn ghost" id="clearBtn">Limpiar</button>
      <div style="margin-left:auto;min-width:220px;text-align:right">
        <div class="small">Lista local ‚Äî archivos generados</div>
      </div>
    </div>

    <div id="status" class="note" style="margin-top:10px"></div>

    <!-- audio central -->
    <audio id="audio" controls style="display:none"></audio>

    <section style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Archivos generados</h3>
      <div class="list" id="filesList">
        <!-- items appended aqu√≠ -->
      </div>
    </section>

    <section style="margin-top:12px">
      <h3 style="margin:0 0 8px 0">Grabaci√≥n (micr√≥fono)</h3>
      <div class="row">
        <button class="btn ghost" id="recStart">üéôÔ∏è Iniciar</button>
        <button class="btn ghost" id="recStop" disabled>‚èπ Detener</button>
        <div style="margin-left:auto" class="small" id="recStatus"></div>
      </div>
      <div class="note">La grabaci√≥n se convertir√° a WAV y se a√±adir√° a la lista de archivos generados.</div>
    </section>

    <section style="margin-top:12px">
      <label class="note">(Opcional) Selecciona un archivo local para renombrar / preparar para el dispositivo</label>
      <input id="fileInput" type="file" accept="audio/*" />
      <div class="row" style="margin-top:8px">
        <button class="btn ghost" id="prepareLocal">Preparar (renombrar)</button>
        <input id="prefix" type="text" placeholder="0001" style="width:120px;margin-left:8px;border-radius:8px;padding:8px"/>
      </div>
      <div id="fileInfo" class="note"></div>
    </section>
  </main>

  <!-- ASIDE -->
  <aside class="card">
    <h3 style="margin-top:0">C√≥mo copiar los audios al dispositivo</h3>
    <ol class="note">
      <li>Conecta el dispositivo a la PC mediante USB o saca la microSD y usa un lector.</li>
      <li>Enciende el dispositivo (si aplica) y abre el Explorador/Finder.</li>
      <li>Copia los archivos MP3/WAV generados a la carpeta ra√≠z de la tarjeta/dispositivo.</li>
      <li>Usa nombres sencillos con prefijo num√©rico (ej. <code>0001.mp3</code>, <code>0002.mp3</code>).</li>
      <li>Expulsa la tarjeta de forma segura y prueba la reproducci√≥n en el dispositivo.</li>
    </ol>

    <h4 style="margin-top:12px">Subida por red (opcional)</h4>
    <label class="small">IP del dispositivo (si acepta uploads)</label>
    <input id="espIp" type="text" placeholder="192.168.4.1" />
    <div style="display:flex;gap:8px;margin-top:8px">
      <button class="btn" id="uploadBtn">Subir al dispositivo</button>
      <button class="btn ghost" id="refreshList">Refrescar lista</button>
    </div>

    <div style="margin-top:12px">
      <div class="note"><strong>Nota:</strong> Para que la generaci√≥n de MP3 funcione desde TTS en el navegador necesitas configurar la variable <code>API_KEY</code> dentro de este archivo (uso local). Si no la configuras se usar√° la voz del navegador solo para previsualizar.</div>
    </div>

    <hr style="border-color:rgba(255,255,255,0.03);margin:12px 0">

    <div style="color:var(--muted);font-size:13px">Made with ‚ù§Ô∏è for TalkBud ‚Äî Demo escolar</div>
  </aside>
</div>

<footer>¬© TalkBud 2025 ‚Äî Proyecto escolar</footer>
```

  </div>

<script>
/*
  CONFIG:
  - Para generar MP3 desde ElevenLabs en el navegador (demo local),
    pega tu clave en API_KEY abajo en tu copia local del archivo.
  - NO subas tu copia con la API_KEY a repositorios p√∫blicos.
*/
const API_KEY = ''; // <-- Pega tu ElevenLabs xi-api-key aqu√≠ para que "Generar & Descargar" cree MP3 desde TTS

function elevenEndpoint(voiceId){ return `https://api.elevenlabs.io/v1/text-to-speech/${voiceId}`; }
function setStatus(txt, err=false){ const s=document.getElementById('status'); s.textContent=txt; s.style.color = err ? '#ffb4b4' : '#bfefff'; }

// Utilities
function makeFilename(ext='mp3'){
  const t=new Date(); const y=t.getFullYear(); const m=String(t.getMonth()+1).padStart(2,'0'); const d=String(t.getDate()).padStart(2,'0');
  const hh=String(t.getHours()).padStart(2,'0'); const mm=String(t.getMinutes()).padStart(2,'0'); return `talkbud_${y}${m}${d}_${hh}${mm}.${ext}`;
}

const filesListEl = document.getElementById('filesList');
const audioEl = document.getElementById('audio');
let generatedFiles = []; // {name, blob}

// add file to UI & memory
function addFileItem(name, blob){
  generatedFiles.unshift({name, blob});
  const el = document.createElement('div'); el.className='item';
  const meta = document.createElement('div'); meta.className='meta';
  const fn = document.createElement('div'); fn.className='filename'; fn.textContent = name;
  meta.appendChild(fn);

  const actions = document.createElement('div'); actions.className='actions';
  const play = document.createElement('button'); play.className='btn ghost'; play.textContent='Play';
  const down = document.createElement('button'); down.className='btn'; down.textContent='Download';
  const del = document.createElement('button'); del.className='btn ghost'; del.textContent='Delete';

  play.onclick = ()=>{ try{ const url=URL.createObjectURL(blob); audioEl.style.display='block'; audioEl.src=url; audioEl.play().catch(()=>{}); }catch(e){console.error(e); setStatus('No se pudo reproducir', true);} };
  down.onclick = ()=>{ const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=name; document.body.appendChild(a); a.click(); document.body.removeChild(a); };
  del.onclick = ()=>{ filesListEl.removeChild(el); generatedFiles = generatedFiles.filter(f=>f.name!==name); setStatus('Archivo eliminado'); };

  actions.appendChild(play); actions.appendChild(down); actions.appendChild(del);
  el.appendChild(meta); el.appendChild(actions);
  filesListEl.prepend(el);
  setStatus('Archivo a√±adido a la lista: ' + name);
}

// create FileList helper
function createFileList(file){
  const dt = new DataTransfer();
  dt.items.add(file);
  return dt.files;
}

// --- TTS generation (ElevenLabs if API_KEY set) ---
document.getElementById('genBtn').addEventListener('click', async ()=>{
  const text = document.getElementById('text').value.trim();
  if(!text){ alert('Escribe una frase'); return; }
  const voiceId = document.getElementById('voice').value;
  const format = document.getElementById('format').value;

  if(API_KEY && API_KEY.length>0){
    // call ElevenLabs
    try{
      setStatus('Generando audio (ElevenLabs)...');
      document.getElementById('genBtn').disabled = true;
      const acceptType = format === 'wav' ? 'audio/wav' : 'audio/mpeg';
      const res = await fetch(elevenEndpoint(voiceId), {
        method: 'POST',
        headers: {
          'Accept': acceptType,
          'Content-Type': 'application/json',
          'xi-api-key': API_KEY
        },
        body: JSON.stringify({ text, model_id: 'eleven_multilingual_v2', voice_settings:{stability:0.5,similarity_boost:0.75} })
      });
      if(!res.ok){ const txt = await res.text(); throw new Error(txt || ('HTTP ' + res.status)); }
      const blob = await res.blob();
      if(!blob.type.startsWith('audio')) throw new Error('Respuesta no es audio: '+blob.type);
      const ext = format==='wav' ? 'wav' : 'mp3';
      const filename = makeFilename(ext);
      addFileItem(filename, blob);
      // auto-select for upload input (optional)
      try{ document.getElementById('fileInput').files = createFileList(new File([blob], filename, {type:blob.type})); }catch(e){}
      // auto download
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href=url; a.download=filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
      audioEl.style.display='block'; audioEl.src = url;
      setStatus('Generado y descargado: ' + filename);
    }catch(err){
      console.error(err);
      setStatus('Error al generar: ' + (err.message||err), true);
      alert('Error al generar audio. Revisa la consola.');
    } finally {
      document.getElementById('genBtn').disabled = false;
    }

  } else {
    // Fallback: preview with browser TTS
    setStatus('API_KEY no configurada ‚Äî vista previa con voz del navegador (sin MP3).');
    const utter = new SpeechSynthesisUtterance(text);
    utter.lang = document.getElementById('lang').value || 'es-ES';
    speechSynthesis.cancel(); // reset
    speechSynthesis.speak(utter);
    alert('Vista previa reproducida con la voz del navegador. Para descargar MP3 desde TTS, edita la variable API_KEY dentro del archivo.');
  }
});

// clear
document.getElementById('clearBtn').addEventListener('click', ()=>{ document.getElementById('text').value=''; setStatus('Limpiado'); });

// --- Recording (getUserMedia -> decode -> WAV blob) ---
let mediaRecorder = null;
let recordedChunks = [];
const recStart = document.getElementById('recStart');
const recStop = document.getElementById('recStop');
const recStatus = document.getElementById('recStatus');

recStart.addEventListener('click', async ()=>{
  if(!navigator.mediaDevices || !navigator.mediaDevices.getUserMedia){ alert('Tu navegador no soporta grabaci√≥n (usa Chrome/Edge/Firefox modernos).'); return; }
  try{
    const stream = await navigator.mediaDevices.getUserMedia({ audio:true });
    mediaRecorder = new MediaRecorder(stream);
    recordedChunks = [];
    mediaRecorder.ondataavailable = e => { if(e.data && e.data.size>0) recordedChunks.push(e.data); };
    mediaRecorder.onstop = async ()=>{
      recStatus.textContent = '';
      setStatus('Procesando grabaci√≥n...');
      const rawBlob = new Blob(recordedChunks, { type: recordedChunks[0]?.type || 'audio/webm' });
      // Try to decode to AudioBuffer and convert to WAV for compatibility
      try{
        const arrayBuffer = await rawBlob.arrayBuffer();
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        const decoded = await audioCtx.decodeAudioData(arrayBuffer);
        const wavBlob = audioBufferToWavBlob(decoded);
        const filename = makeFilename('wav');
        addFileItem(filename, wavBlob);
        // auto-select for file input
        try{ document.getElementById('fileInput').files = createFileList(new File([wavBlob], filename, {type:wavBlob.type})); }catch(e){}
        setStatus('Grabaci√≥n lista: ' + filename);
      }catch(err){
        console.warn('No se pudo convertir a WAV, se guarda el original.', err);
        const filename = makeFilename().replace('.mp3','.webm');
        addFileItem(filename, rawBlob);
        setStatus('Grabaci√≥n guardada en formato original: ' + filename);
      }
    };
    mediaRecorder.start();
    recStatus.textContent = 'Grabando...';
    setStatus('Grabando...');
    recStart.disabled = true; recStop.disabled = false;
  }catch(err){
    console.error(err);
    setStatus('No se pudo acceder al micr√≥fono', true);
    alert('Error accediendo al micr√≥fono. Verifica permisos.');
  }
});

recStop.addEventListener('click', ()=>{ if(mediaRecorder && mediaRecorder.state !== 'inactive'){ mediaRecorder.stop(); recStart.disabled=false; recStop.disabled=true; } });

// WAV encoder helpers
function audioBufferToWavBlob(buffer, opt){
  opt = opt || {}; var numChannels = buffer.numberOfChannels; var sampleRate = buffer.sampleRate;
  var format = 1; var bitDepth = 16;
  var result;
  if(numChannels === 2) result = interleave(buffer.getChannelData(0), buffer.getChannelData(1)); else result = buffer.getChannelData(0);
  return encodeWAV(result, numChannels, sampleRate, format, bitDepth);
}
function interleave(inputL, inputR){ var length = inputL.length + inputR.length; var result = new Float32Array(length); var index=0,inputIndex=0; while(index<length){ result[index++] = inputL[inputIndex]; result[index++] = inputR[inputIndex]; inputIndex++; } return result; }
function floatTo16BitPCM(output, offset, input){ for(var i=0;i<input.length;i++,offset+=2){ var s=Math.max(-1,Math.min(1,input[i])); output.setInt16(offset, s<0? s*0x8000 : s*0x7FFF, true); } }
function writeString(view, offset, string){ for(var i=0;i<string.length;i++){ view.setUint8(offset+i, string.charCodeAt(i)); } }
function encodeWAV(samples, numChannels, sampleRate, format, bitDepth){
  var bytesPerSample = bitDepth/8; var blockAlign = numChannels * bytesPerSample;
  var buffer = new ArrayBuffer(44 + samples.length * bytesPerSample); var view = new DataView(buffer);
  writeString(view, 0, 'RIFF'); view.setUint32(4, 36 + samples.length * bytesPerSample, true); writeString(view, 8, 'WAVE');
  writeString(view, 12, 'fmt '); view.setUint32(16, 16, true); view.setUint16(20, format, true);
  view.setUint16(22, numChannels, true); view.setUint32(24, sampleRate, true); view.setUint32(28, sampleRate * blockAlign, true);
  view.setUint16(32, blockAlign, true); view.setUint16(34, bitDepth, true); writeString(view, 36, 'data'); view.setUint32(40, samples.length * bytesPerSample, true);
  if(format === 1) floatTo16BitPCM(view, 44, samples); else { var offset=44; for(var i=0;i<samples.length;i++,offset+=4) view.setFloat32(offset, samples[i], true); }
  return new Blob([view], { type: 'audio/wav' });
}

// --- Prepare local file (rename) ---
document.getElementById('prepareLocal').addEventListener('click', ()=>{
  const fi = document.getElementById('fileInput');
  const prefix = (document.getElementById('prefix').value || '').trim();
  if(!fi.files || fi.files.length===0){ alert('Selecciona un archivo primero'); return; }
  const file = fi.files[0];
  const ext = (file.name.split('.').pop() || '').toLowerCase() || 'mp3';
  const safePrefix = prefix ? prefix.replace(/[^0-9a-zA-Z_-]/g,'') + '_' : '';
  const filename = (safePrefix + file.name).replace(/\s+/g, '_');
  const url = URL.createObjectURL(file);
  const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); document.body.removeChild(a);
  setStatus('Archivo preparado: ' + filename);
  document.getElementById('fileInfo').innerHTML = `<div class="small">Archivo listo: <strong>${filename}</strong>. Copia al dispositivo.</div>`;
});

// --- Upload to device by IP (optional) ---
document.getElementById('uploadBtn').addEventListener('click', async ()=>{
  const ip = document.getElementById('espIp').value.trim();
  if(!ip){ alert('Introduce la IP del dispositivo (ej. 192.168.4.1)'); return; }
  // pick first generated file or file input
  let fileToSend = null;
  if(document.getElementById('fileInput').files && document.getElementById('fileInput').files.length>0) fileToSend = document.getElementById('fileInput').files[0];
  else if(generatedFiles.length>0) fileToSend = generatedFiles[0].blob ? new File([generatedFiles[0].blob], generatedFiles[0].name, {type: generatedFiles[0].blob.type}) : null;
  if(!fileToSend){ alert('No hay archivo para subir. Genera o selecciona uno.'); return; }
  setStatus('Subiendo a dispositivo ' + ip + ' ...');
  try{
    const form = new FormData(); form.append('audio', fileToSend);
    const res = await fetch(`http://${ip}/upload`, { method:'POST', body: form });
    if(!res.ok) throw new Error('Upload fall√≥: '+res.statusText);
    setStatus('Subida exitosa');
    alert('Subida completada (si el dispositivo soporta /upload).');
  }catch(err){ console.error(err); setStatus('Error al subir: '+(err.message||err), true); alert('Error al subir. Verifica IP y que el dispositivo acepte uploads.'); }
});

// refresh list button: clear UI list and re-add from memory
document.getElementById('refreshList').addEventListener('click', ()=>{
  filesListEl.innerHTML=''; generatedFiles.forEach(f=>addFileItem(f.name,f.blob));
  setStatus('Lista local actualizada');
});

</script>

</body>
</html>
